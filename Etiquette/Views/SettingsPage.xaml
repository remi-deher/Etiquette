<Page
    x:Class="Etiquette.Views.SettingsPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:converters="using:Etiquette.Converters" 
    mc:Ignorable="d"
    Background="{ThemeResource ApplicationPageBackgroundThemeBrush}">

    <ScrollViewer VerticalScrollBarVisibility="Auto">
        <StackPanel Spacing="24" Padding="40" MaxWidth="800" HorizontalAlignment="Left">

            <TextBlock Text="Paramètres" Style="{StaticResource TitleTextBlockStyle}"/>

            <Border Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" Padding="24" CornerRadius="8" BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}" BorderThickness="1">
                <StackPanel Spacing="16">
                    <StackPanel Orientation="Horizontal" Spacing="10">
                        <FontIcon Glyph="&#xE774;" FontFamily="Segoe MDL2 Assets"/>
                        <TextBlock Text="Mode de fonctionnement" Style="{StaticResource SubtitleTextBlockStyle}"/>
                    </StackPanel>
                    <Border Height="1" Background="Gray" Opacity="0.1"/>

                    <ComboBox Header="Rôle de ce poste" 
                              ItemsSource="{x:Bind ViewModel.AppModes}" 
                              SelectedValue="{x:Bind ViewModel.SelectedAppMode, Mode=TwoWay}" 
                              SelectedValuePath="Key" 
                              DisplayMemberPath="Label" 
                              HorizontalAlignment="Stretch"/>

                    <InfoBar Severity="Informational" IsOpen="True" IsClosable="False" 
                             Title="Info"
                             Message="Le mode 'Monoposte' utilise une base locale. Les autres modes activent les fonctions réseau."/>
                </StackPanel>
            </Border>

            <Border Visibility="{x:Bind ViewModel.IsDbConfigVisible, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}"
                    Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" Padding="24" CornerRadius="8" BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}" BorderThickness="1">
                <StackPanel Spacing="16">
                    <StackPanel Orientation="Horizontal" Spacing="10">
                        <FontIcon Glyph="&#xE7F8;" FontFamily="Segoe MDL2 Assets"/>
                        <TextBlock Text="Base de Données Distante" Style="{StaticResource SubtitleTextBlockStyle}"/>
                    </StackPanel>
                    <Border Height="1" Background="Gray" Opacity="0.1"/>

                    <TextBox Header="Serveur" Text="{x:Bind ViewModel.DbServer, Mode=TwoWay}" PlaceholderText="IP ou DNS"/>
                    <Grid ColumnSpacing="15">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <TextBox Grid.Column="0" Header="Nom BDD" Text="{x:Bind ViewModel.DbName, Mode=TwoWay}"/>
                        <TextBox Grid.Column="1" Header="Utilisateur" Text="{x:Bind ViewModel.DbUser, Mode=TwoWay}"/>
                    </Grid>
                    <PasswordBox Header="Mot de passe" Password="{x:Bind ViewModel.DbPassword, Mode=TwoWay}"/>

                    <ComboBox Header="Mode SSL" ItemsSource="{x:Bind ViewModel.SslModes}" SelectedItem="{x:Bind ViewModel.SelectedSslMode, Mode=TwoWay}" HorizontalAlignment="Stretch"/>
                </StackPanel>
            </Border>

            <Border Visibility="{x:Bind ViewModel.IsDbConfigVisible, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}"
                    Background="{ThemeResource LayerFillColorAltBrush}" Padding="24" CornerRadius="8" BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}" BorderThickness="1">
                <StackPanel Spacing="16">
                    <StackPanel Orientation="Horizontal" Spacing="10">
                        <FontIcon Glyph="&#xE90F;" FontFamily="Segoe MDL2 Assets" Foreground="{ThemeResource SystemAccentColor}"/>
                        <TextBlock Text="Assistant de configuration de base de donnée" Style="{StaticResource SubtitleTextBlockStyle}"/>
                    </StackPanel>
                    <Border Height="1" Background="Gray" Opacity="0.1"/>

                    <TextBlock Text="Générez le script SQL pour créer votre base de données sur le serveur." Foreground="Gray" FontSize="12"/>

                    <Grid ColumnSpacing="15">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <ComboBox Grid.Column="0" Header="Type de Serveur" 
                                  ItemsSource="{x:Bind ViewModel.DbTypes}" 
                                  SelectedItem="{x:Bind ViewModel.SelectedDbType, Mode=TwoWay}" 
                                  HorizontalAlignment="Stretch"/>

                        <Button Grid.Column="1" Content="Générer le script" 
                                Command="{x:Bind ViewModel.GenerateSqlCommand}" 
                                VerticalAlignment="Bottom" Style="{StaticResource AccentButtonStyle}"/>
                    </Grid>

                    <TextBox Header="Script à exécuter sur le serveur :" FontFamily="Consolas" Height="120" 
                             IsReadOnly="True" TextWrapping="Wrap" AcceptsReturn="True"
                             Text="{x:Bind ViewModel.SqlOutput, Mode=OneWay}"
                             Background="{ThemeResource ControlFillColorInputActiveBrush}"/>
                </StackPanel>
            </Border>

            <Border Visibility="{x:Bind ViewModel.IsPairingAllowed, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}"
                    Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" Padding="24" CornerRadius="8" BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}" BorderThickness="1">
                <StackPanel Spacing="16">
                    <StackPanel Orientation="Horizontal" Spacing="10">
                        <FontIcon Glyph="&#xE72E;" FontFamily="Segoe MDL2 Assets"/>
                        <TextBlock Text="Ajout de nouveaux postes" Style="{StaticResource SubtitleTextBlockStyle}"/>
                    </StackPanel>
                    <Border Height="1" Background="Gray" Opacity="0.1"/>

                    <TextBlock Text="Activez ce mode temporairement pour autoriser un nouveau poste à récupérer la configuration." Foreground="Gray" FontSize="12" TextWrapping="Wrap"/>

                    <StackPanel Orientation="Horizontal" Spacing="15">
                        <ComboBox Header="Durée" SelectedIndex="{x:Bind ViewModel.SelectedDurationIndex, Mode=TwoWay}" Width="150">
                            <x:String>5 minutes</x:String>
                            <x:String>10 minutes</x:String>
                            <x:String>15 minutes</x:String>
                            <x:String>30 minutes</x:String>
                        </ComboBox>

                        <Button Command="{x:Bind ViewModel.TogglePairingCommand}" VerticalAlignment="Bottom" Style="{StaticResource AccentButtonStyle}" Width="220">
                            <StackPanel Orientation="Horizontal" Spacing="10">
                                <FontIcon Glyph="{x:Bind ViewModel.IsPairingActive, Mode=OneWay, Converter={StaticResource BoolToLockIconConverter}}"/>
                                <TextBlock Text="{x:Bind ViewModel.IsPairingActive, Mode=OneWay, Converter={StaticResource BoolToActionTextConverter}}"/>
                            </StackPanel>
                        </Button>
                    </StackPanel>

                    <InfoBar IsOpen="True" IsClosable="False" 
                             Severity="{x:Bind ViewModel.IsPairingActive, Mode=OneWay, Converter={StaticResource BoolToSeverityConverter}}"
                             Message="{x:Bind ViewModel.PairingStatusText, Mode=OneWay}"/>
                </StackPanel>
            </Border>

            <Border Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" Padding="24" CornerRadius="8" BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}" BorderThickness="1">
                <StackPanel Spacing="16">
                    <StackPanel Orientation="Horizontal" Spacing="10">
                        <FontIcon Glyph="&#xE749;" FontFamily="Segoe MDL2 Assets"/>
                        <TextBlock Text="Impression" Style="{StaticResource SubtitleTextBlockStyle}"/>
                    </StackPanel>
                    <Border Height="1" Background="Gray" Opacity="0.1"/>
                    <ComboBox Header="Imprimante par défaut" ItemsSource="{x:Bind ViewModel.InstalledPrinters}" SelectedItem="{x:Bind ViewModel.SelectedPrinter, Mode=TwoWay}" HorizontalAlignment="Stretch"/>
                </StackPanel>
            </Border>

            <StackPanel Spacing="20">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    <TextBlock Text="{x:Bind ViewModel.StatusMessage, Mode=OneWay}" Foreground="{ThemeResource SystemFillColorSuccessBrush}" VerticalAlignment="Center" FontWeight="Bold"/>
                    <Button Grid.Column="1" Content="Enregistrer tout" Command="{x:Bind ViewModel.SaveSettingsCommand}" Style="{StaticResource AccentButtonStyle}"/>
                </Grid>

                <Button Command="{x:Bind ViewModel.RestartWizardCommand}" HorizontalAlignment="Center" Margin="0,20,0,0">
                    <StackPanel Orientation="Horizontal" Spacing="10">
                        <FontIcon Glyph="&#xE72C;" FontFamily="Segoe MDL2 Assets"/>
                        <TextBlock Text="Relancer l'assistant de configuration initiale"/>
                    </StackPanel>
                </Button>
            </StackPanel>

        </StackPanel>
    </ScrollViewer>
</Page>
<Page
    x:Class="Etiquette.Views.SetupWizardPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    mc:Ignorable="d"
    Background="{ThemeResource ApplicationPageBackgroundThemeBrush}">

    <Grid>
        <Grid.Background>
            <SolidColorBrush Color="{ThemeResource SystemAltHighColor}"/>
        </Grid.Background>

        <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center" Spacing="40" MaxWidth="700">

            <StackPanel HorizontalAlignment="Center" Spacing="10">
                <FontIcon Glyph="&#xE9D5;" FontSize="50" FontFamily="Segoe MDL2 Assets" Foreground="{ThemeResource AccentTextFillColorPrimaryBrush}"/>
                <TextBlock Text="Configuration Initiale" Style="{StaticResource TitleTextBlockStyle}" HorizontalAlignment="Center"/>
            </StackPanel>

            <Border Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" 
                    BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}" 
                    BorderThickness="1" CornerRadius="12" Padding="40" MinWidth="550">
                <Grid>

                    <StackPanel x:Name="Step1_Hardware" Spacing="25" Visibility="Visible">
                        <TextBlock Text="Configuration du Matériel" 
                                   Style="{StaticResource SubtitleTextBlockStyle}" HorizontalAlignment="Center" TextAlignment="Center"/>

                        <StackPanel Spacing="10">
                            <TextBlock Text="1. Imprimante à étiquettes" FontWeight="SemiBold"/>
                            <InfoBar Severity="Informational" IsOpen="True" IsClosable="False"
                                     Message="Sélectionnez l'imprimante utilisée pour l'édition."/>

                            <ComboBox x:Name="CmbPrinters" HorizontalAlignment="Stretch" 
                                      PlaceholderText="Choisir une imprimante..."/>

                            <HyperlinkButton Content="Ouvrir les paramètres d'imprimantes Windows" 
                                             Click="OnOpenWindowsPrinters" FontSize="12"/>
                        </StackPanel>

                        <Rectangle Height="1" Fill="{ThemeResource CardStrokeColorDefaultBrush}" Margin="0,5"/>

                        <StackPanel Spacing="10">
                            <TextBlock Text="2. Lecteur Code-Barres (Scanette)" FontWeight="SemiBold"/>
                            <TextBlock Text="Si vous avez une douchette, testez-la dans la case ci-dessous :" 
                                       Foreground="Gray" FontSize="12"/>

                            <Grid ColumnSpacing="10">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <TextBox x:Name="TxtScanTest" PlaceholderText="Scannez un article ici pour tester..." 
                                         TextChanged="OnScanTestInput"/>

                                <FontIcon x:Name="IconScanStatus" Grid.Column="1" Glyph="&#xE73E;" 
                                          Foreground="Green" Visibility="Collapsed" FontSize="20"/>
                            </Grid>
                            <TextBlock x:Name="TxtScanFeedback" Text="Scanner détecté !" Foreground="Green" 
                                       FontSize="12" Visibility="Collapsed"/>
                        </StackPanel>

                        <Button Content="Valider le matériel et Continuer" Click="OnHardwareValidated" 
                                Style="{StaticResource AccentButtonStyle}" HorizontalAlignment="Stretch" Margin="0,15,0,0"/>
                    </StackPanel>

                    <StackPanel x:Name="Step2_ModeChoice" Spacing="30" Visibility="Collapsed">
                        <TextBlock Text="Quel est votre usage ?"
                                   Style="{StaticResource SubtitleTextBlockStyle}" HorizontalAlignment="Center" TextAlignment="Center"/>

                        <Grid ColumnSpacing="20">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>

                            <Button Grid.Column="0" Click="OnGoToMultiPoste" HorizontalAlignment="Stretch" Height="100" Padding="10">
                                <StackPanel Spacing="8">
                                    <FontIcon Glyph="&#xE711;" FontSize="24"/>
                                    <TextBlock Text="Plusieurs postes" FontWeight="Bold"/>
                                    <TextBlock Text="Données partagées (Base de donnée partagé)" 
                                               FontSize="11" Foreground="Gray" TextAlignment="Center"/>
                                </StackPanel>
                            </Button>

                            <Button Grid.Column="1" Click="OnGoToStandalone" HorizontalAlignment="Stretch" Height="100" Style="{StaticResource AccentButtonStyle}" Padding="10">
                                <StackPanel Spacing="8">
                                    <FontIcon Glyph="&#xE73E;" FontSize="24"/>
                                    <TextBlock Text="Poste unique (Mono poste)" FontWeight="Bold"/>
                                    <TextBlock Text="Base de données locale" 
                                               FontSize="11" Foreground="White" Opacity="0.8" TextAlignment="Center"/>
                                </StackPanel>
                            </Button>
                        </Grid>

                        <Button Content="Retour" Click="OnBackToStep1" HorizontalAlignment="Center" Margin="0,10,0,0"/>
                    </StackPanel>

                    <StackPanel x:Name="Step3_RoleChoice" Spacing="30" Visibility="Collapsed">
                        <TextBlock Text="Configuration Réseau" 
                                   Style="{StaticResource SubtitleTextBlockStyle}" HorizontalAlignment="Center" TextAlignment="Center"/>

                        <InfoBar Severity="Warning" IsOpen="True" IsClosable="False"
                                 Title="Important"
                                 Message="Une base de données partagée (MySQL, PostgreSQL, Oracle ou Microsoft SQL Server) est nécessaire pour ce mode."/>

                        <Grid ColumnSpacing="20">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>

                            <Button Grid.Column="0" Click="OnGoToNewServer" HorizontalAlignment="Stretch" Height="80">
                                <StackPanel Spacing="5">
                                    <FontIcon Glyph="&#xE968;" FontSize="24"/>
                                    <TextBlock Text="Nouvelle configuration multi poste"/>
                                    <TextBlock Text="(Première configuration)" FontSize="10" Foreground="Gray"/>
                                </StackPanel>
                            </Button>

                            <Button Grid.Column="1" Click="OnGoToDiscovery" HorizontalAlignment="Stretch" Height="80" Style="{StaticResource AccentButtonStyle}">
                                <StackPanel Spacing="5">
                                    <FontIcon Glyph="&#xE8EB;" FontSize="24"/>
                                    <TextBlock Text="J'ai déja un poste de configuré"/>
                                    <TextBlock Text="(Recherche auto)" FontSize="10" Foreground="White" Opacity="0.8"/>
                                </StackPanel>
                            </Button>
                        </Grid>
                        <Button Content="Retour" Click="OnBackToStep2" HorizontalAlignment="Center" Margin="0,10,0,0"/>
                    </StackPanel>

                    <StackPanel x:Name="Step4_ServerConfig" Spacing="25" Visibility="Collapsed">
                        <TextBlock Text="Paramètres de Connexion" Style="{StaticResource SubtitleTextBlockStyle}" HorizontalAlignment="Center"/>

                        <InfoBar Severity="Informational" IsOpen="True" IsClosable="False" 
                                 Message="Renseignez les informations de votre serveur de base de données (MySQL, PostgreSQL, Oracle ou SQL Server)."/>

                        <Grid ColumnSpacing="15" RowSpacing="15">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>

                            <TextBox x:Name="TxtServerIp" Grid.Column="0" Header="Adresse IP Serveur" PlaceholderText="ex: 192.168.1.15"/>
                            <TextBox x:Name="TxtDbName" Grid.Column="1" Header="Nom de la base" Text="labelmaster"/>

                            <TextBox x:Name="TxtUser" Grid.Column="0" Grid.Row="1" Header="Utilisateur" Text="label_user"/>
                            <PasswordBox x:Name="TxtPassword" Grid.Column="1" Grid.Row="1" Header="Mot de passe"/>

                            <ComboBox x:Name="CmbSslMode" Grid.Row="2" Grid.Column="0" Header="Mode SSL" HorizontalAlignment="Stretch" SelectedIndex="0">
                                <x:String>None</x:String>
                                <x:String>Preferred</x:String>
                                <x:String>Required</x:String>
                                <x:String>VerifyCA</x:String>
                                <x:String>VerifyFull</x:String>
                            </ComboBox>

                            <ComboBox x:Name="CmbDbType" Grid.Row="2" Grid.Column="1" 
                                      Header="Type de Serveur" HorizontalAlignment="Stretch" SelectedIndex="0"
                                      SelectionChanged="OnGenerateSql">
                                <x:String>MariaDB / MySQL</x:String>
                                <x:String>PostgreSQL</x:String>
                                <x:String>Microsoft SQL Server</x:String>
                                <x:String>Oracle</x:String>
                            </ComboBox>
                        </Grid>

                        <Border Background="{ThemeResource LayerFillColorAltBrush}" 
                                BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}" 
                                BorderThickness="1" CornerRadius="8" Padding="15">
                            <StackPanel Spacing="10">
                                <TextBlock Text="Script SQL (Pour création initiale si besoin) :" 
                                           FontWeight="Bold" Foreground="{ThemeResource SystemAccentColor}"/>

                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBox x:Name="TxtSqlOutput" FontFamily="Consolas" Height="60" 
                                             IsReadOnly="True" TextWrapping="Wrap" AcceptsReturn="True"
                                             Background="{ThemeResource ControlFillColorInputActiveBrush}"/>

                                    <Button Grid.Column="1" Click="OnGenerateSql" VerticalAlignment="Stretch" Margin="10,0,0,0">
                                        <FontIcon Glyph="&#xE8C8;"/>
                                    </Button>
                                </Grid>
                            </StackPanel>
                        </Border>

                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" Spacing="10">
                            <Button Content="Retour" Click="OnBackToStep3"/>
                            <Button Content="Terminer" Click="OnValidateServerConfig" Style="{StaticResource AccentButtonStyle}"/>
                        </StackPanel>
                    </StackPanel>

                    <StackPanel x:Name="Step4_Discovery" Spacing="25" Visibility="Collapsed">
                        <StackPanel Spacing="10" HorizontalAlignment="Center">
                            <ProgressRing IsActive="{x:Bind _isSearching, Mode=OneWay}" Width="50" Height="50"/>
                            <TextBlock Text="{x:Bind _discoveryStatus, Mode=OneWay}" Style="{StaticResource SubtitleTextBlockStyle}" TextAlignment="Center"/>
                        </StackPanel>

                        <StackPanel x:Name="PinEntryPanel" Spacing="15" Visibility="Collapsed">
                        </StackPanel>

                        <Button Content="Retour" Click="OnBackToStep3" HorizontalAlignment="Center" Margin="0,20,0,0"/>
                    </StackPanel>

                </Grid>
            </Border>
            <ProgressBar x:Name="WizardProgress" Value="0" Maximum="100" Width="200"/>
        </StackPanel>
    </Grid>
</Page>